<div class="plan-container">
  <!-- Header with navigation and stadium info -->
  <header class="header">
    <button class="back-btn" (click)="goBackToStadiums()" title="بازگشت به لیست سالن‌ها">
      ← بازگشت
    </button>

    <div class="stadium-info" *ngIf="seatMap">
      <h1 class="stadium-name">{{ seatMap.name || 'نقشه سالن' }}</h1>
      <span class="stadium-id">{{ seatMap.id }}</span>
    </div>

    <div class="legend">
      <div class="legend-item">
        <div class="legend-color available"></div>
        <span>آزاد</span>
      </div>
      <div class="legend-item">
        <div class="legend-color reserved"></div>
        <span>رزرو شده</span>
      </div>
      <div class="legend-item">
        <div class="legend-color selected"></div>
        <span>انتخاب شده</span>
      </div>
    </div>
  </header>

  <!-- Loading state -->
  <div *ngIf="loading" class="loading">
    <div class="spinner"></div>
    <p>در حال بارگذاری نقشه صندلی‌ها...</p>
  </div>

  <!-- Error state -->
  <div *ngIf="error && !loading" class="error">
    <p>{{ error }}</p>
    <button class="retry-btn" (click)="retry()">تلاش مجدد</button>
  </div>

  <!-- Seat map visualization -->
  <div *ngIf="!loading && !error && seatMap" class="seat-map-wrapper">
    <!-- Map info -->
    <div class="map-info">
      <span>تعداد صندلی‌ها: {{ seatMap.rows * seatMap.columns }}</span>
      <span *ngIf="getSelectedSeatCount() > 0">انتخاب شده: {{ getSelectedSeatCount() }}</span>
    </div>

    <!-- Stage/Screen indicator -->
    <div class="stage">
      <span>صحنه / زمین بازی</span>
    </div>

    <!-- Seat grid with conditional virtual scrolling -->
    <div #seatMapContainer class="seat-grid-container" [class.virtual-scroll]="useVirtualScroll">
      <!-- Virtual scrolling mode for large maps -->
      <div
        *ngIf="useVirtualScroll"
        class="virtual-seat-grid"
        [style.height.px]="getTotalHeight()"
        [style.width.px]="getTotalWidth()"
      >
        <div
          *ngFor="let row of virtualRows; let index = index; trackBy: trackByRow"
          class="virtual-seat-row"
          [style.transform]="'translateY(' + getRowOffset(index) + 'px)'"
        >
          <!-- Row number -->
          <div class="row-label">{{ getVirtualRowIndex(index) + 1 }}</div>

          <!-- Visible seats in row -->
          <div
            *ngFor="let seatInfo of getVisibleSeats(row); trackBy: trackBySeat"
            class="seat-wrapper"
            [style.transform]="'translateX(' + seatInfo.index * 22 + 'px)'"
          >
            <div
              class="seat-container"
              [class]="getSeatClass(getVirtualRowIndex(index), seatInfo.index)"
              (click)="onSeatClick(getVirtualRowIndex(index), seatInfo.index)"
              [attr.aria-label]="
                'صندلی ردیف ' + (getVirtualRowIndex(index) + 1) + ' شماره ' + (seatInfo.index + 1)
              "
              [attr.aria-pressed]="
                getSeatStatus(getVirtualRowIndex(index), seatInfo.index) === SeatStatus.SELECTED
              "
              [attr.disabled]="
                getSeatStatus(getVirtualRowIndex(index), seatInfo.index) === SeatStatus.RESERVED
                  ? true
                  : null
              "
              tabindex="0"
              role="button"
              (keydown.enter)="onSeatClick(getVirtualRowIndex(index), seatInfo.index)"
              (keydown.space)="onSeatClick(getVirtualRowIndex(index), seatInfo.index)"
            >
              <svg class="seat-icon">
                <use href="assets/icons.svg#seat-icon"></use>
              </svg>
              <!-- No seat numbers in virtual mode for performance -->
            </div>
          </div>

          <!-- Row number (right side) -->
          <div class="row-label right">{{ getVirtualRowIndex(index) + 1 }}</div>
        </div>
      </div>

      <!-- Standard rendering mode for smaller maps -->
      <div
        *ngIf="!useVirtualScroll"
        class="standard-seat-grid"
        [style.--rows]="seatMap.rows"
        [style.--columns]="seatMap.columns"
      >
        <div
          *ngFor="let row of seatMap.seats; let rowIndex = index; trackBy: trackByRow"
          class="seat-row"
        >
          <!-- Row number -->
          <div class="row-label">{{ rowIndex + 1 }}</div>

          <!-- Seats in row -->
          <div
            *ngFor="let seat of row; let colIndex = index; trackBy: trackBySeat"
            class="seat-wrapper"
          >
            <div
              class="seat-container"
              [class]="getSeatClass(rowIndex, colIndex)"
              (click)="onSeatClick(rowIndex, colIndex)"
              [attr.aria-label]="'صندلی ردیف ' + (rowIndex + 1) + ' شماره ' + (colIndex + 1)"
              [attr.aria-pressed]="getSeatStatus(rowIndex, colIndex) === SeatStatus.SELECTED"
              [attr.disabled]="
                getSeatStatus(rowIndex, colIndex) === SeatStatus.RESERVED ? true : null
              "
              tabindex="0"
              role="button"
              (keydown.enter)="onSeatClick(rowIndex, colIndex)"
              (keydown.space)="onSeatClick(rowIndex, colIndex)"
            >
              <svg class="seat-icon">
                <use href="assets/icons.svg#seat-icon"></use>
              </svg>
              <!-- Seat content - can be customized for different seat types -->
              <span class="seat-number" *ngIf="seatMap.columns <= 50">
                {{ colIndex + 1 }}
              </span>
            </div>
          </div>

          <!-- Row number (right side) -->
          <div class="row-label">{{ rowIndex + 1 }}</div>
        </div>
      </div>
    </div>

    <!-- Purchase messages -->
    <div *ngIf="purchaseSuccess" class="purchase-message success">
      <div class="message-content">
        <span class="message-text">{{ purchaseSuccess }}</span>
        <button class="close-btn" (click)="dismissPurchaseMessages()" title="بستن پیام">×</button>
      </div>
    </div>

    <div *ngIf="purchaseError" class="purchase-message error">
      <div class="message-content">
        <span class="message-text">{{ purchaseError }}</span>
        <button class="close-btn" (click)="dismissPurchaseMessages()" title="بستن پیام">×</button>
      </div>
    </div>

    <!-- Selection summary and purchase -->
    <div *ngIf="getSelectedSeatCount() > 0" class="selection-summary">
      <h3>صندلی‌های انتخاب شده:</h3>
      <div class="selected-seats">
        <span *ngFor="let coord of getSelectedCoordinates()" class="selected-coord">
          ({{ coord.x + 1 }}, {{ coord.y + 1 }})
        </span>
      </div>

      <div class="action-buttons">
        <button
          class="purchase-btn"
          (click)="purchaseSelectedSeats()"
          [disabled]="purchasing"
          [attr.aria-label]="'خرید ' + getSelectedSeatCount() + ' صندلی انتخاب شده'"
        >
          <span *ngIf="!purchasing">خرید بلیت ({{ getSelectedSeatCount() }} صندلی)</span>
          <span *ngIf="purchasing" class="purchasing-text">
            <span class="spinner-small"></span>
            در حال خرید...
          </span>
        </button>

        <button
          class="clear-btn"
          (click)="clearSelection()"
          [disabled]="purchasing"
          title="پاک کردن تمام انتخاب‌ها"
        >
          پاک کردن انتخاب‌ها
        </button>
      </div>
    </div>
  </div>

  <!-- Empty state -->
  <div *ngIf="!loading && !error && !seatMap" class="empty-state">
    <p>نقشه‌ای یافت نشد</p>
    <button class="back-btn" (click)="goBackToStadiums()">بازگشت به لیست سالن‌ها</button>
  </div>
</div>
